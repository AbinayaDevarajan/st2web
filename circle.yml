# Setup in CircleCI account the following ENV variables:
# BINTRAY_ORGANIZATION
# BINTRAY_ACCOUNT
# BINTRAY_API_KEY
general:
  artifacts:
    - ~/packages

machine:
  environment:
    DISTROS: "wheezy jessie trusty el7"
    PKGTYPE: "deb deb deb rpm"
    ST2_PACKAGES_REPO: https://github.com/StackStorm/st2-packages
    DEPLOY_PACKAGES: 1
  pre:
    - mkdir -p ~/packages

checkout:
  post:
    - git clone -b fix/bintray_nextrevision_reuse --depth 1 ${ST2_PACKAGES_REPO} ~/st2-packages
    - ~/st2-packages/.circle/build-web-env.sh

dependencies:
  pre:
    - sudo apt-get install rpm
    - npm install bower
  post:
    - node_modules/.bin/bower install

test:
  post:
    - node_modules/.bin/gulp production
    - dpkg-buildpackage -b -uc -us
    - rpmbuild -bb rpm/st2web.spec

deployment:
  publish:
    owner: StackStorm
    branch:
      - master
      - /v[0-9]+(\.[0-9]+)*/
      - feature/circleci
    commands:
      # Deploy to Bintray all artifacts for respective distros in parallel
      - |
        DISTROS=($DISTROS)
        PKGTYPE=($PKGTYPE)
        for i in ${!DISTROS[@]}; do
          mkdir -p ~/packages/${DISTROS[$i]}
          cp ../*.${PKGTYPE[$i]} ~/packages/${DISTROS[$i]}
          echo Deploying Bintray artifacts for "${DISTROS[$i]}" ...
        done
        wait
      #   .circle/bintray.sh deploy ${DISTROS[$i]}_staging ~/packages/${DISTROS[$i]} &
      - ~/st2-packages/.circle/save_payload.py ~/packages

# experimental:
#   notify:
#     branches:
#       only:
#         - master
#         - /v[0-9]+(\.[0-9]+)*/
