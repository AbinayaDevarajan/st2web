<div class="st2-panel" ng-class="{'st2-panel--slide': $root.state.includes('*.details')}">

  <div class="st2-history">
    <nav class="navbar navbar-default" role="navigation">
      <div class="container-fluid">
        <form>

          <div class="st2-details__form-group st2-details__form-group--right">
            <input type="text" class="st2-details__form-control st2-details__form-control--left" placeholder="Search">
            <button type="submit" class="st2-details__button">Submit</button>
          </div>

          <div class="st2-details__form-group">
            <ui-select ng-model="filter.selected">
              <ui-select-match placeholder="Action">
                <div class="st2-forms__matcher">{{ $select.selected.name }}</div>
              </ui-select-match>
              <ui-select-choices repeat="action in actions">
                {{ action.name }}
              </ui-select-choices>
            </ui-select>

            <ui-select ng-model="filter.selected">
              <ui-select-match placeholder="Trigger">
                <div class="st2-forms__matcher">{{ $select.selected.name }}</div>
              </ui-select-match>
              <ui-select-choices repeat="trigger in triggers">
                {{ trigger.name }}
              </ui-select-choices>
            </ui-select>

            <ui-select ng-model="filter.selected">
              <ui-select-match placeholder="Rule">
                <div class="st2-forms__matcher">{{ $select.selected.name }}</div>
              </ui-select-match>
              <ui-select-choices repeat="rule in rules">
                {{ rule.name }}
              </ui-select-choices>
            </ui-select>
          </div>

        </form>
      </div>
    </nav>

    <div class="st2-panel__panel" ng-repeat="group in history | orderBy:'period':true">
      <div class="st2-panel__heading">
        <h2 class="st2-panel__heading-title">{{ group.period | date:'fullDate'}}</h2>
      </div>

      <div class="st2-flex-table">
        <div class="st2-flex-table__header">
          <div class="st2-flex-table__column st2-history__column-utility"></div>
          <div class="st2-flex-table__column st2-history__column-time">Started At</div>
          <div class="st2-flex-table__column st2-history__column-action">Action Name</div>
          <div class="st2-flex-table__column st2-history__column-triggered">Triggered By</div>
          <div class="st2-flex-table__column st2-history__column-status">Status</div>
        </div>

        <div class="st2-flex-table__row"
            ng-class-odd="'st2-flex-table__row--odd'"
            ng-class-even="'st2-flex-table__row--even'"
            ng-repeat-start="record in group.records"
            ng-click="$root.state.go('^.summary', {id: record.id})">
          <div class="st2-flex-table__column st2-history__column-utility"
              ng-click="isExpandable(record) &&
                (record._expanded && contract(record) || expand(record))">
            <i ng-class="record._expanded && 'st2-icon__expanded' || 'st2-icon__contracted'"
                ng-if="isExpandable(record)">
            </i>
          </div>
          <div class="st2-flex-table__column st2-history__column-time">
            {{ record.execution.start_timestamp.split(' ').join('T') | date:'mediumTime' }}
          </div>
          <div class="st2-flex-table__column st2-history__column-action">
            {{ record.action.name }}
          </div>
          <div class="st2-flex-table__column st2-history__column-triggered"
              ng-switch="record.rule && record.trigger && true">
            <span ng-switch-when="true">{{ record.rule.name }} ({{ record.trigger.type }})</span>
            <span ng-switch-default>Manual</span>
          </div>
          <div class="st2-flex-table__column st2-history__column-status">
            <span class="st2-label" status="record.execution.status"></span>
          </div>
        </div>
        <div class="st2-history-child"
            children="record._children"
            ng-if="isExpandable(record) && record._expanded">
        </div>
        <div ng-repeat-end
            class="st2-flex-table__header"
            ng-if="isExpandable(record) && record._expanded && !$last">
          <div class="st2-flex-table__column st2-history__column-utility"></div>
          <div class="st2-flex-table__column st2-history__column-time">Started At</div>
          <div class="st2-flex-table__column st2-history__column-action">Action Name</div>
          <div class="st2-flex-table__column st2-history__column-triggered">Triggered By</div>
          <div class="st2-flex-table__column st2-history__column-status">Status</div>
        </div>

      </div>
    </div>

    <button class="st2-panel__prev-button"
        ng-click="prevPage()"
        ng-if="$root.page > 1">
      Previous page
    </button>
    <button class="st2-panel__next-button"
        ng-click="nextPage()"
        ng-if="($root.page || 1) < $root.maxPage">
      Next page
    </button>

    <div class="st2-panel__back-button"
      ng-click="$root.state.go('^.summary', {id: record.id})"></div>
  </div>

  <div class="st2-summary">
    <div>
      <div class="st2-summary__heading">
        <h2 class="st2-summary__heading-title">Summary</h2>
        <button class="st2-summary__button st2-summary__button--right" title="Details"
            ng-click="$root.state.go('^.details', {id: record.id})"
            ng-if="!$root.state.includes('*.details')">
          Details
        </button>
        <button class="st2-summary__button st2-summary__button--right" title="Details"
            ng-click="$root.state.go('^.summary', {id: record.id})"
            ng-if="$root.state.includes('*.details')">
          &lt;- Back
        </button>
      </div>

      <div class="st2-summary__body">
        <dl>
          <dt ng-if="record.rule.name">Rule Name</dt>
          <dd ng-if="record.rule.name">{{ record.rule.name }}</dd>

          <dt ng-if="record.rule.description">Rule Description</dt>
          <dd ng-if="record.rule.description">{{ record.rule.description }}</dd>

          <dt>Action</dt>
          <dd>{{ record.action.name }}</dd>

          <dt>Runner</dt>
          <dd>{{ record.action.runner_type }}</dd>

          <dt>Execution Status</dt>
          <dd>
            <span class="st2-label" status="record.execution.status"></span>
          </dd>
        </dl>
      </div>
    </div>
  </div>

</div>

<div class="st2-details">
  <form role="form" class="st2-details__form">
    <div class="st2-details__panel">
      <div class="st2-details__panel-heading">
        <h2 class="st2-details__panel-title">Action Input</h2>
      </div>
      <div class="st2-details__panel-body">
        <div class="st2-auto-form"
          spec="spec"
          result="payload">
        </div>
      </div>
    </div>

    <div class="st2-details__panel">
      <div class="st2-details__panel-heading">
        <h2 class="st2-details__panel-title">History Record Details</h2>
      </div>
      <div class="st2-details__panel-body">
        <dl>
          <dt ng-if="record.rule.name">Rule Name</dt>
          <dd ng-if="record.rule.name">{{ record.rule.name }}</dd>

          <dt ng-if="record.rule.description">Rule Description</dt>
          <dd ng-if="record.rule.description">{{ record.rule.description }}</dd>

          <dt ng-if="record.trigger.name">Trigger Name</dt>
          <dd ng-if="record.trigger.name">{{ record.trigger.name }}</dd>

          <dt ng-if="record.trigger_instance.occurrence_time">Occurrence time</dt>
          <dd ng-if="record.trigger_instance.occurrence_time">
            {{ record.trigger_instance.occurrence_time | date:'medium' }}
          </dd>

          <dt ng-if="record.trigger_instance.payload">Trigger payload</dt>
          <dd ng-if="record.trigger_instance.payload">
            {{ record.trigger_instance.payload | json }}
          </dd>

          <dt>Action</dt>
          <dd>{{ record.action.name }}</dd>

          <dt>Runner</dt>
          <dd>{{ record.action.runner_type }}</dd>
        </dl>
      </div>
    </div>

    <div class="st2-details__panel">
      <div class="st2-details__panel-heading">
        <h2 class="st2-details__panel-title">Action Output</h2>
      </div>
      <div class="st2-details__panel-body">
        <div class="st2-action-reporter"
          runner="record.runner.name"
          execution="record.execution"></div>
      </div>
    </div>
  </form>
</div>
